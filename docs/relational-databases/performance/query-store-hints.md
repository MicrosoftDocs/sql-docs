---
title: "Query Store hints (Preview)"
description: Learn about the SQL Server Hints feature to shape query plans without changing application code.
ms.custom: ""
ms.date: "6/9/2021"
ms.prod: sql
ms.prod_service: "database-engine, sql-database"
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords: 
  - "Query Store"
dev_langs:
 - "TSQL"
author: WilliamDAssafMSFT
ms.author: wiassaf
monikerRange: "=azuresqldb-current||=azuresqldb-mi-current"
---
# Query Store hints (Preview)
[!INCLUDE [asdb-asdbmi](../../includes/applies-to-version/asdb-asdbmi.md)]

This article outlines the Query Store hints feature of the [Query Store](monitoring-performance-by-using-the-query-store.md). The Query Store hints feature provides an easy-to-use method for shaping query plans without changing application code. 

> [!Note]
> Query Store hints are a public preview feature currently available in [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)] â€“ including in Azure SQL single databases, elastic pools, managed instances, and hyperscale databases.  

## Overview

Ideally the Query Optimizer selects an optimal execution plan for a query. When this doesn't happen, a developer or DBA may wish to manually optimize for specific conditions. Query hints are specified via the OPTION clause and can be used to affect behavior of operators in a statement. While query hints help provide localized solutions to various performance-related issues, they do require a rewrite of the original query text. Database administrators and developers may not always be able to make changes directly to [!INCLUDE[tsql](../../includes/tsql-md.md)] code to inject a query hint. The [!INCLUDE[tsql](../../includes/tsql-md.md)] may be hard-coded into an application or automatically generated by the application. Previously, a developer may have to rely on [plan guides](plan-guides.md), which can be complex to use.

## When to use Query Store hints

As the name suggests, this feature extends and depends on the [Query Store](monitoring-performance-by-using-the-query-store.md). Query Store enables the capturing of queries, execution plans, and associated runtime statistics. Introduced in [!INCLUDE[sssql16-md](../../includes/sssql16-md.md)] and on-by-default in [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)], Query Store greatly simplifies the overall performance tuning customer experience.  

Examples where Query Store hints can help with query-level performance issues:
*    Recompile a query on each execution.
*    Cap the memory grant size for a bulk insert operation.
*    Limit the maximum degree of parallelism for a statistics update operation.
*    Use a Hash join instead of a Nested Loops join.
*    Use [compatibility level](../databases/view-or-change-the-compatibility-level-of-a-database.md) 110 for a specific query while keeping everything else in the database at compatibility level 150.
*    Disable row goal optimization for a SELECT TOP query.

To use Query Store hints, do the following:
1.    Identify the Query Store query_id of the query statement you wish to modify. You can do this in various ways: 
    1.1. Querying the [Query Store catalog views](../system-catalog-views/query-store-catalog-views-transact-sql.md).
    1.1. Using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] built-in Query Store reports.
    1.1. Using Azure portal Query Performance Insight for [!INCLUDE[ssSDSfull](../../includes/sssdsfull-md.md)].
1.    Execute sp_query_store_set_hints with the query_id and query hint string you wish to apply to the query.  This string can contain one or more query hints. For complete information, see [sys.sp_query_store_set_hints](../system-stored-procedures/sys-sp-query-store-set-hints-transact-sql.md).

Once created, Query Store hints are persisted and survive restarts and failovers. Query Store hints override hard-coded statement level hints and existing plan guide hints. 

If a query hint contradicts what is possible for query optimization, the hint will not block query execution and the hint will not be applied. In the cases where a hint would cause a query to fail, the hint is ignored and the latest failure details can be viewed in [sys.query_store_query_hints](../system-catalog-views/sys-query-store-query-hints-transact-sql.md).

## Query Store hints system stored procedures

To create or update hints, use [sys.sp_query_store_set_hints](../system-stored-procedures/sys-sp-query-store-set-hints-transact-sql.md):

```syntaxsql
sp_query_store_set_hints
    @query_id bigint,
    @query_hints nvarchar(max)
```
 
Hints are specified in a valid string format N'OPTION (...)'. 

> [!Note]
> For a complete list of hints that are supported, see [sys.sp_query_store_set_hints](../system-stored-procedures/sys-sp-query-store-set-hints-transact-sql.md).

* If no Query Store hint exists for a specific query_id, a new Query Store hint will be created. 
* If a Query Store hint already exists for a specific query_id, the last value provided will override previously specified values for the associated query. 
* If a query_id doesn't exist, an error will be raised. 

To remove hints associated with a query_id, use [sys.sp_query_store_clear_hints](../system-stored-procedures/sys-sp-query-store-clear-hints-transact-sql.md):

```syntaxsql 
sp_query_store_clear_hints 
    @query_id bigint
```

## Execution Plan XML attributes

When hints are applied, the following will be surfaced in the StmtSimple element of the [Execution Plan](execution-plans.md) in [XML format](save-an-execution-plan-in-xml-format.md):

|Attribute| Description|
|--|--|
|QueryStoreStatementHintText|Actual Query Store hint(s) applied to the query|
|QueryStoreStatementHintId|Unique identifier of a query hint|
|QueryStoreStatementHintSource|Source of Query Store hint (ex: "User")|

> [!Note]
> During the Query Store hints public preview, these XML elements will be available only via the output of the [!INCLUDE[tsql](../../includes/tsql-md.md)] commands [SET STATISTICS XML](../../t-sql/statements/set-statistics-xml-transact-sql.md) and [SET SHOWPLAN XML](../../t-sql/statements/set-showplan-xml-transact-sql.md).


## Examples  

### A. Query Store hints demo
The following walk-through of the Query Store hints feature in Azure SQL Database uses an imported database via a BACPAC file (.bacpac). Learn how to import a new database to an Azure SQL Database server, see [Quickstart: Import a BACPAC file to a database](/azure/azure-sql/database/database-import).

:::code language="tsql" source="../../sql-server-samples/samples/features/query-store/Query%20Store%20Hints%20Demo.sql":::

### B. Identify a query in Query Store

The following example queries [sys.query_store_query_text](../system-catalog-views/sys-query-store-query-text-transact-sql.md) and [sys.query_store_query](../system-catalog-views/sys-query-store-query-transact-sql.md) to return the query_id for an executed query text fragment:

```sql
SELECT q.query_id, qt.query_sql_text
FROM sys.query_store_query_text qt 
INNER JOIN sys.query_store_query q ON 
    qt.query_text_id = q.query_text_id 
WHERE query_sql_text like N'%ORDER BY ListingPrice DESC%'  
  AND query_sql_text not like N'%query_store%';
GO
```

 Then, apply the hint to enforce a maximum memory grant size in percent of configured memory limit to the query_id (in this example, query_id in the previous query's resultset was 39):
  
```sql
EXEC sys.sp_query_store_set_hints @query_id= 39, @query_hints = N'OPTION(MAX_GRANT_PERCENT=10)';
```  

 You can also apply query hints with the following syntax, for example the option to force the [legacy cardinality estimator](../performance/cardinality-estimation-sql-server.md):

```sql
EXEC sys.sp_query_store_set_hints @query_id= 39, @query_hints = N'OPTION(USE HINT(''FORCE_LEGACY_CARDINALITY_ESTIMATION''))';
```  

 You can apply multiple query hints with a comma-separated list:

```sql
EXEC sys.sp_query_store_set_hints @query_id= 39, @query_hints = N'OPTION(RECOMPILE, MAXDOP 1, USE HINT(''QUERY_OPTIMIZER_COMPATIBILITY_LEVEL_110''))';
```

 Review the Query Store hint in place for query_id 39:

```sql
SELECT query_hint_id, query_id, query_hint_text, last_query_hint_failure_reason, last_query_hint_failure_reason_desc, query_hint_failure_count, source, source_desc 
FROM sys.query_store_query_hints 
WHERE query_id = 39;
```

## Next steps

- [Hints (Transact-SQL) - Query](../../t-sql/queries/hints-transact-sql-query.md)  
- [Best practices with Query Store](best-practice-with-the-query-store.md)
- [Monitor performance by using Query Store](../../relational-databases/performance/monitoring-performance-by-using-the-query-store.md)
- [Configure the max degree of parallelism (MAXDOP) in Azure SQL Database](/azure/azure-sql/database/configure-max-degree-of-parallelism)

## See also
- [sys.query_store_query_hints (Transact-SQL)](../system-catalog-views/sys-query-store-query-hints-transact-sql.md)   
- [sys.sp_query_store_set_hints (Transact-SQL)](../system-stored-procedures/sys-sp-query-store-set-hints-transact-sql.md)   
- [sys.sp_query_store_clear_hints (Transact-SQL)](../system-stored-procedures/sys-sp-query-store-clear-hints-transact-sql.md)   
- [Save an Execution Plan in XML Format](save-an-execution-plan-in-xml-format.md)
- [Display and Save Execution Plans](display-and-save-execution-plans.md)
